#cloud-config
package_update: true

runcmd:
  # 1) Install Git, wget, Miniconda
  - apt-get update -y
  - apt-get install -y git wget bzip2
  - wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/mc.sh
  - bash /tmp/mc.sh -b -p /home/azureuser/miniconda
  - chown -R azureuser:azureuser /home/azureuser/miniconda
  - echo 'export PATH="/home/azureuser/miniconda/bin:$PATH"' >> /home/azureuser/.bashrc

  # 2) Clone your demo repo (with qr_seed.bin inside)
  - su - azureuser -c '
      source ~/.bashrc &&
      git clone https://github.com/TDMD2/qrngq.git ~/qrngq
    '

  # 3) Create Conda env & install deps
  - su - azureuser -c '
      source ~/.bashrc &&
      conda create -y -n qrng-demo python=3.10 &&
      conda activate qrng-demo &&
      pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu117 &&
      pip install numpy
    '

  # 4) Run the benchmark from the cloned repo
  - su - azureuser -c '
      source ~/.bashrc &&
      conda activate qrng-demo &&
      cd ~/qrngq &&
      python3 run_bench.py > /home/azureuser/bench.log 2>&1
    '
